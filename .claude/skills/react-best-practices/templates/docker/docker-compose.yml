# React 项目 Docker Compose 配置
# 支持开发、测试、生产多环境部署

version: '3.8'

services:
  # ===== 开发环境 React 应用（支持热重载）=====
  app-dev:
    image: ${IMAGE_NAME:-myapp}-dev:${IMAGE_TAG:-latest}
    container_name: ${CONTAINER_NAME:-myapp-dev}
    build:
      context: ../..
      dockerfile: templates/docker/Dockerfile
      args:
        NPM_REGISTRY: ${NPM_REGISTRY:-https://registry.npmmirror.com}
        PORT: ${APP_PORT:-5173}
    ports:
      - "${HOST_PORT:-5173}:${APP_PORT:-5173}"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=${APP_PORT:-5173}
      # Vite 环境变量（以 VITE_ 开头）
      - VITE_API_URL=${VITE_API_URL:-http://localhost:8000}
      - VITE_APP_TITLE=${VITE_APP_TITLE:-My App}
      - VITE_ENV=${ENV:-development}

    # 开发环境挂载源码（支持热重载）
    volumes:
      - ../../src:/app/src
      - ../../public:/app/public
      - ../../index.html:/app/index.html
      - ../../vite.config.ts:/app/vite.config.ts
      # 排除 node_modules（使用容器内的）
      - /app/node_modules

    networks:
      - app-network

    restart: unless-stopped

    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${APP_PORT:-5173}/"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

    # 仅在开发环境启动
    profiles:
      - dev

  # ===== 生产环境 React 应用（Nginx）=====
  app-prod:
    image: ${IMAGE_NAME:-myapp}-prod:${IMAGE_TAG:-latest}
    container_name: ${CONTAINER_NAME:-myapp-prod}
    build:
      context: ../..
      dockerfile: templates/docker/Dockerfile.nginx
      args:
        NPM_REGISTRY: ${NPM_REGISTRY:-https://registry.npmmirror.com}
        VITE_API_URL: ${VITE_API_URL:-https://api.example.com}
        VITE_APP_TITLE: ${VITE_APP_TITLE:-My App}
    ports:
      - "${HOST_PORT:-80}:80"

    networks:
      - app-network

    restart: unless-stopped

    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

    # 仅在生产环境启动
    profiles:
      - prod

  # ===== 后端 API 服务（可选）=====
  # 如果你的 React 应用需要连接后端 API，可以取消注释
  # backend:
  #   image: your-backend-image:latest
  #   container_name: ${BACKEND_CONTAINER_NAME:-myapp-backend}
  #   ports:
  #     - "${BACKEND_PORT:-8000}:8000"
  #   environment:
  #     - ENV=${ENV:-development}
  #     - DATABASE_URL=${DATABASE_URL}
  #   networks:
  #     - app-network
  #   restart: unless-stopped

# ===== 网络配置 =====
networks:
  app-network:
    driver: bridge
